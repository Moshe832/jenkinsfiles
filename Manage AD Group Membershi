pipeline {
    agent any

    parameters {
        string(name: 'JSON_FILE', defaultValue: 'C:\\Temp\\TempGroupUsers.json', description: 'Path to JSON file with users and groups')
    }

    environment {
        JSON_PATH = "${params.JSON_FILE}"
        TODAY_DATE = "${new Date().format('yyyy-MM-dd')}"
    }

    stages {
        stage('Echo Parameters') {
            steps {
                powershell """
                Write-Host "JSON_PATH: ${env.JSON_PATH}"
                Write-Host "TODAY_DATE: ${env.TODAY_DATE}"
                """
            }
        }

        stage('Manage AD Group Membership') {
            steps {
                powershell """
                Import-Module ActiveDirectory
                \$today = Get-Date

                # Read JSON
                \$usersList = Get-Content -Path '${env.JSON_PATH}' | ConvertFrom-Json

                foreach (\$entry in \$usersList) {
                    \$user = \$entry.User.Trim()
                    \$group = \$entry.Group.Trim()
                    \$addedDate = [datetime]\$entry.Date.Trim()
                    \$expiryDate = \$addedDate.AddDays(30)

                    # Check if user is in AD group
                    \$isMember = Get-ADGroupMember -Identity \$group -Recursive | Where-Object { \$_.SamAccountName -eq \$user }

                    if (\$expiryDate -ge \$today) {
                        # Within 30 days: add if not in group
                        if (-not \$isMember) {
                            Add-ADGroupMember -Identity \$group -Members \$user
                            Write-Host "\$user added to \$group (within 30 days)"
                        } else {
                            Write-Host "\$user already in \$group (within 30 days)"
                        }
                    } else {
                        # Expired: remove if in group
                        if (\$isMember) {
                            Remove-ADGroupMember -Identity \$group -Members \$user -Confirm:\$false
                            Write-Host "\$user removed from \$group (expired)"
                        } else {
                            Write-Host "\$user not in \$group (expired)"
                        }
                    }
                }
                """
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully."
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}
