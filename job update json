pipeline {
    agent { label 'dc' }

    parameters {
        string(name: 'UserName', description: 'Username (e.g., john.doe)')
        string(name: 'GroupName', description: 'Group name')
        string(name: 'StartDate', description: 'Start date (yyyy-MM-dd)')
    }

    stages {
        stage('Append to JSON') {
            steps {
                powershell '''
                $jsonPath = "D:\\Manage\\userAccessList"
                $newEntry = @{
                    UserName  = "$env:UserName"
                    GroupName = "$env:GroupName"
                    StartDate = "$env:StartDate"
                }

                if (Test-Path $jsonPath) {
                    $data = Get-Content $jsonPath | ConvertFrom-Json
                } else {
                    $data = @()
                }

                $exists = $data | Where-Object {
                    $_.UserName -eq $newEntry.UserName -and
                    $_.GroupName -eq $newEntry.GroupName
                }

                if (-not $exists) {
                    $data += New-Object PSObject -Property $newEntry
                    $data | ConvertTo-Json -Depth 5 | Set-Content -Path $jsonPath
                    Write-Host "Entry appended to JSON"
                } else {
                    Write-Host "Entry already exists â€” skipping append"
                }
                '''
            }
        }

        stage('Trigger AD Job') {
            steps {
                build job: 'Manage-AD-Users-And-Groups'
            }
        }
    }
}