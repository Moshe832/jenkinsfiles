pipeline {
    agent any

    parameters {
        string(name: 'USERS', defaultValue: 'moshe.cohen dana.lavi eli', description: 'List of users (sAMAccountName), separated by space or comma')
        string(name: 'GROUP', defaultValue: 'TestGroup', description: 'Target group name')
        string(name: 'JSON_FILE', defaultValue: 'C:\\Temp\\TempGroupUsers.json', description: 'Path to save the JSON file')
    }

    environment {
        USERS_LIST = "${params.USERS}"
        TARGET_GROUP = "${params.GROUP}"
        JSON_PATH = "${params.JSON_FILE}"
        TODAY_DATE = "${new Date().format('yyyy-MM-dd')}"
    }

    stages {
        stage('Append or Update Users in JSON') {
            steps {
                powershell """
                # Echo environment variables
                Write-Host "USERS_LIST: ${env.USERS_LIST}"
                Write-Host "TARGET_GROUP: ${env.TARGET_GROUP}"
                Write-Host "JSON_PATH: ${env.JSON_PATH}"
                Write-Host "TODAY_DATE: ${env.TODAY_DATE}"

                # Split USERS parameter by space or comma
                \$newUsers = '${env.USERS_LIST}' -split '[ ,]+' | Where-Object { \$_ -ne '' }
                \$today = '${env.TODAY_DATE}'

                # Load JSON or start empty
                if (Test-Path '${env.JSON_PATH}') {
                    \$jsonList = Get-Content -Path '${env.JSON_PATH}' | ConvertFrom-Json
                } else {
                    \$jsonList = @()
                }

                foreach (\$user in \$newUsers) {
                    # Check if user already exists in the JSON for the same group
                    \$existing = \$jsonList | Where-Object { \$_ .User -eq \$user -and \$_ .Group -eq '${env.TARGET_GROUP}' }
                    if (\$existing) {
                        # Update the Date to today
                        \$existing.Date = \$today
                    } else {
                        # Add new entry
                        \$jsonList += @{User=\$user.Trim(); Group='${env.TARGET_GROUP}'; Date=\$today}
                    }
                }

                # Save updated JSON
                \$jsonList | ConvertTo-Json -Depth 3 | Out-File -FilePath '${env.JSON_PATH}' -Encoding UTF8
                Write-Host "JSON updated at ${env.JSON_PATH}"
                """
            }
        }
    }
}
