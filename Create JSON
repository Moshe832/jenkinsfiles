pipeline {
    agent any

    options {
        // Clean the workspace before starting
        cleanWs()
    }

    parameters {
        string(name: 'USERS', defaultValue: 'moshe.cohen dana.lavi eli', description: 'List of users (sAMAccountName), separated by space or comma')
        string(name: 'GROUP', defaultValue: 'TestGroup', description: 'Target group name')
        string(name: 'DAYS', defaultValue: '30', description: 'Number of days for expiry')
        string(name: 'JSON_FILE', defaultValue: 'C:\\Temp\\TempGroupUsers.json', description: 'Path to save the JSON file')
    }

    stages {
        stage('Append Users to JSON') {
            steps {
                powershell """
                # Split the USERS parameter by space or comma
                \$newUsers = '${params.USERS}' -split '[ ,]+' | Where-Object { \$_ -ne '' }

                # Check if JSON file exists
                if (Test-Path '${params.JSON_FILE}') {
                    # Load existing JSON
                    \$jsonList = Get-Content -Path '${params.JSON_FILE}' | ConvertFrom-Json
                } else {
                    # Start with empty list if file does not exist
                    \$jsonList = @()
                }

                # Append new users
                foreach (\$user in \$newUsers) {
                    # Avoid duplicates
                    if (-not (\$jsonList | Where-Object { \$_ .User -eq \$user -and \$_ .Group -eq '${params.GROUP}' })) {
                        \$jsonList += @{User=\$user.Trim(); Group='${params.GROUP}'; Days=${params.DAYS}}
                    }
                }

                # Save updated JSON back to file
                \$jsonList | ConvertTo-Json -Depth 3 | Out-File -FilePath '${params.JSON_FILE}' -Encoding UTF8

                Write-Host "JSON updated at ${params.JSON_FILE}"
                """
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully."
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}
