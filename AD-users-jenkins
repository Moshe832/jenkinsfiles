pipeline {
    agent { label 'windows' }

    parameters {
        text(
            name: 'USERS',
            description: 'List of AD users (one user per line)'
        )
    }

    environment {
        OU    = 'OU=Users,DC=domain,DC=local'
        GROUP = 'GroupX'
    }

    stages {
        stage('AD User Management') {
            steps {
                withCredentials([string(credentialsId: 'AD_DEFAULT_PASSWORD', variable: 'DEFAULT_PASSWORD')]) {
                    powershell '''
Import-Module ActiveDirectory

$Users     = $env:USERS -split "`r?`n" | Where-Object { $_.Trim() -ne "" }
$OU        = $env:OU
$GroupName = $env:GROUP
$Password  = $env:DEFAULT_PASSWORD

foreach ($UserName in $Users) {

    Write-Host "=== Processing user: $UserName ==="

    $user = Get-ADUser -Filter "SamAccountName -eq '$UserName'" -ErrorAction SilentlyContinue

    if (-not $user) {
        Write-Host "User not found ‚Äì creating new user"

        New-ADUser `
            -Name $UserName `
            -SamAccountName $UserName `
            -AccountPassword (ConvertTo-SecureString $Password -AsPlainText -Force) `
            -Enabled $true `
            -Path $OU `
            -ChangePasswordAtLogon $true
    }
    else {
        Write-Host "‚úÖ User already exists"
    }

    $IsMember = Get-ADUser $UserName -Properties MemberOf |
                Select-Object -ExpandProperty MemberOf |
                Where-Object { $_ -like "*CN=$GroupName,*" }

    if (-not $IsMember) {
        Add-ADGroupMember -Identity $GroupName -Members $UserName
        Write-Host "‚ûï User added to group $GroupName"
    }
    else {
        Write-Host "‚ÑπÔ∏è User is already a member of the group"
    }

    Set-ADAccountPassword `
        -Identity $UserName `
        -NewPassword (ConvertTo-SecureString $Password -AsPlainText -Force) `
        -Reset

    Unlock-ADAccount -Identity $UserName
    Write-Host "üîë Password updated"
}
'''
                }
            }
        }
    }

    post {
        success {
            echo 'AD user management completed successfully'
            cleanWs()
        }
        failure {
            echo 'AD user management failed'
            cleanWs()
        }
    }
}
